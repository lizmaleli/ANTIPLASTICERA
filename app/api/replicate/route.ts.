import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  try {
    const { prompt, aspect_ratio = "1:1", size = "2K" } = await req.json();

    const resp = await fetch("https://api.replicate.com/v1/predictions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${process.env.REPLICATE_API_TOKEN!}`,
        "Content-Type": "application/json",
        Prefer: "wait" // let Replicate block until the output is ready
      },
      body: JSON.stringify({
        version: "054cd8c667f535616fd66710ce20c8949bf64ac3d9a3459e338f026424be8bec",
        input: {
          prompt: `${prompt}. Ultra realistic, high-end photography, professional lighting, luxury aesthetic, 4K quality, editorial magazine style`,
          negative_prompt: "low quality, blurry, distorted, plastic, fake, unrealistic, amateur, bad lighting",
          aspect_ratio,
          size
        }
      })
    });

    if (!resp.ok) {
      const err = await resp.json().catch(() => ({}));
      return NextResponse.json({ error: err.detail || "Replicate failed" }, { status: 500 });
    }

    const data = await resp.json();
    const out = Array.isArray(data.output) ? data.output[0] : data.output;
    return NextResponse.json({ imageUrl: out ?? null, raw: data });
  } catch (e: any) {
    return NextResponse.json({ error: e.message || "Server error" }, { status: 500 });
  }
}

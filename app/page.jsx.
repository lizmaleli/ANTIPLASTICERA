import React, { useState, useRef, useEffect } from 'react';
import { Send, Upload, Loader2, Download, Sparkles } from 'lucide-react';

export default function AntiplasticEraStudio() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [uploadedImage, setUploadedImage] = useState(null);
  const [generatedImages, setGeneratedImages] = useState([]);
  const [userNiche, setUserNiche] = useState('');
  const messagesEndRef = useRef(null);
  const fileInputRef = useRef(null);

  const sceneSuggestions = {
    fashion: [
      { title: 'Golden Hour Lookbook', prompt: 'Fashion editorial, golden hour lighting, outdoor luxury setting, professional photography' },
      { title: 'Interior Elegance', prompt: 'Fashion portrait in luxury interior, soft natural lighting, minimalist aesthetic' },
      { title: 'Street Style Moment', prompt: 'Urban fashion photography, editorial style, natural pose, city backdrop' }
    ],
    food: [
      { title: 'Overhead Plating', prompt: 'Overhead food photography, gourmet plating, natural lighting, restaurant quality' },
      { title: 'Chef in Action', prompt: 'Chef preparing dish, professional kitchen, steam and atmosphere, editorial style' },
      { title: 'Dining Scene', prompt: 'Elegant dining table setup, food styling, soft lighting, luxury restaurant ambiance' }
    ],
    fitness: [
      { title: 'Gym Power Shot', prompt: 'Fitness training moment, gym setting, dramatic lighting, athletic aesthetic' },
      { title: 'Outdoor Workout', prompt: 'Outdoor fitness scene, natural environment, golden hour, athletic photography' },
      { title: 'Wellness Lifestyle', prompt: 'Yoga or wellness moment, serene setting, soft natural light, peaceful atmosphere' }
    ],
    travel: [
      { title: 'Destination Portrait', prompt: 'Travel portrait at iconic location, golden hour, editorial photography style' },
      { title: 'Hotel Luxury', prompt: 'Luxury hotel interior, elegant setting, natural light, high-end travel aesthetic' },
      { title: 'Adventure Scene', prompt: 'Travel adventure moment, scenic backdrop, natural lighting, lifestyle photography' }
    ],
    beauty: [
      { title: 'Product Close-Up', prompt: 'Beauty product photography, clean background, soft lighting, commercial style' },
      { title: 'Skincare Routine', prompt: 'Skincare routine moment, bathroom luxury, natural morning light, lifestyle aesthetic' },
      { title: 'Glam Portrait', prompt: 'Beauty portrait, professional makeup, soft lighting, editorial magazine style' }
    ],
    business: [
      { title: 'Office Aesthetic', prompt: 'Professional office setting, natural light, clean minimal design, corporate lifestyle' },
      { title: 'Laptop Lifestyle', prompt: 'Working on laptop, coffee shop or home office, natural lighting, entrepreneur aesthetic' },
      { title: 'Speaking Moment', prompt: 'Professional speaking or presenting, conference setting, professional photography' }
    ]
  };

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    addMessage('system', 'ðŸ‘‹ Upload an image or tell me your niche to start!');
  }, []);

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setUploadedImage(reader.result);
        addMessage('system', 'âœ¨ Image uploaded! What niche are you in? (fashion, food, fitness, travel, beauty, business)');
      };
      reader.readAsDataURL(file);
    }
  };

  const addMessage = (role, content, image = null) => {
    setMessages(prev => [...prev, { role, content, image, timestamp: Date.now() }]);
  };

  const generateImage = async (prompt) => {
    setIsGenerating(true);
    addMessage('system', 'ðŸŽ¨ Generating your image...');
    try {
      const response = await fetch('/api/replicate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, aspect_ratio: '1:1', size: '2K' })
      });
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'API request failed');
      }
      const { imageUrl } = await response.json();
      if (imageUrl) {
        setGeneratedImages(prev => [...prev, { url: imageUrl, prompt }]);
        addMessage('assistant', 'âœ¨ Image ready! Click a suggestion or ask for captions/hashtags', imageUrl);
      } else {
        throw new Error('Generation failed');
      }
    } catch (error) {
      console.error('Generation error:', error);
      addMessage('system', `âŒ Error: ${error.message}. Check your API key and billing.`);
    } finally {
      setIsGenerating(false);
    }
  };

  const getChatResponse = async (userMessage) => {
    try {
      const response = await fetch('/api/anthropic', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          max_tokens: 500,
          system: `You are a creative director for luxury content. Keep responses SHORT (2-3 sentences max). Suggest premium, editorial-quality content ideas. When asked for captions/hashtags, give 1 caption + 5 hashtags only. Be concise and actionable.`,
          messages: [
            ...messages.filter(m => m.role !== 'system').slice(-4).map(m => ({
              role: m.role === 'assistant' ? 'assistant' : 'user',
              content: m.content
            })),
            { role: 'user', content: userMessage }
          ]
        })
      });
      const data = await response.json();
      if (data.error) throw new Error(data.error);
      const reply = data.text;
      addMessage('assistant', reply);
    } catch (error) {
      addMessage('system', `âŒ ${error.message}`);
    }
  };

  const handleSuggestionClick = (suggestion) => {
    generateImage(suggestion.prompt);
  };

  const handleSend = async () => {
    if (!input.trim()) return;
    const userMessage = input.trim();
    setInput('');
    addMessage('user', userMessage);
    // Detect niche
    const lowerMsg = userMessage.toLowerCase();
    if (lowerMsg.includes('fashion') || lowerMsg.includes('fitness') || lowerMsg.includes('food') ||
        lowerMsg.includes('travel') || lowerMsg.includes('beauty') || lowerMsg.includes('business')) {
      const detected = Object.keys(sceneSuggestions).find(n => lowerMsg.includes(n));
      if (detected) setUserNiche(detected);
    }
    if (lowerMsg.includes('generate') || lowerMsg.includes('create')) {
      await generateImage(userMessage);
    } else {
      await getChatResponse(userMessage);
    }
  };

  const currentSuggestions = userNiche ? sceneSuggestions[userNiche] : sceneSuggestions.fashion;

  return (
    <div className="min-h-screen" style={{ background: 'linear-gradient(135deg, #f5f1ed 0%, #e8e0d5 100%)' }}>
      {/* Header */}
      <header className="py-5 px-6 shadow-sm" style={{ background: '#4a3728' }}>
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-serif" style={{ color: '#f5f1ed' }}>Antiplastic Era</h1>
            <p className="text-sm opacity-80" style={{ color: '#f5f1ed' }}>Luxury Content Studio</p>
          </div>
        </div>
      </header>
      <div className="max-w-7xl mx-auto p-4 md:p-6">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
          {/* Suggestions Sidebar */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl shadow-lg p-4 sticky top-4">
              <h3 className="font-serif text-lg mb-3" style={{ color: '#4a3728' }}>Scene Ideas</h3>
              <div className="space-y-2">
                {currentSuggestions.map((sugg, idx) => (
                  <button
                    key={idx}
                    onClick={() => handleSuggestionClick(sugg)}
                    disabled={isGenerating}
                    className="w-full text-left p-3 rounded-xl transition-all hover:shadow-md disabled:opacity-50"
                    style={{ background: '#f5f1ed', color: '#4a3728' }}
                  >
                    <div className="flex items-center gap-2">
                      <Sparkles size={16} />
                      <span className="text-sm font-medium">{sugg.title}</span>
                    </div>
                  </button>
                ))}
              </div>
             
              {uploadedImage && (
                <div className="mt-4 pt-4 border-t" style={{ borderColor: '#e8e0d5' }}>
                  <p className="text-xs mb-2" style={{ color: '#4a3728' }}>Reference</p>
                  <img src={uploadedImage} alt="Reference" className="w-full rounded-lg" />
                </div>
              )}
            </div>
          </div>
          {/* Chat Area */}
          <div className="lg:col-span-2 bg-white rounded-2xl shadow-lg overflow-hidden">
            <div className="h-[600px] flex flex-col">
              <div className="flex-1 overflow-y-auto p-4 space-y-3">
                {messages.map((msg, idx) => (
                  <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div
                      className="max-w-[85%] rounded-2xl px-4 py-2 text-sm"
                      style={{
                        background: msg.role === 'user' ? '#4a3728' : msg.role === 'system' ? '#f5f1ed' : '#e8e0d5',
                        color: msg.role === 'user' ? '#f5f1ed' : '#4a3728'
                      }}
                    >
                      {msg.image && <img src={msg.image} alt="Gen" className="rounded-lg mb-2 w-full" />}
                      <p className="whitespace-pre-wrap">{msg.content}</p>
                    </div>
                  </div>
                ))}
                {isGenerating && (
                  <div className="flex justify-center">
                    <Loader2 className="animate-spin" size={24} style={{ color: '#4a3728' }} />
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>
              <div className="border-t p-3" style={{ borderColor: '#e8e0d5' }}>
                <div className="flex gap-2">
                  <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="p-3 rounded-xl transition-colors"
                    style={{ background: '#f5f1ed', color: '#4a3728' }}
                  >
                    <Upload size={18} />
                  </button>
                  <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                    placeholder="Ask for captions, scenes, or 'generate [idea]'..."
                    className="flex-1 px-4 py-3 border-2 rounded-xl focus:outline-none"
                    style={{ borderColor: '#e8e0d5' }}
                  />
                  <button
                    onClick={handleSend}
                    disabled={!input.trim()}
                    className="px-5 py-3 rounded-xl transition-all disabled:opacity-50"
                    style={{ background: '#4a3728', color: '#f5f1ed' }}
                  >
                    <Send size={18} />
                  </button>
                </div>
              </div>
            </div>
          </div>
          {/* Gallery */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl shadow-lg p-4 sticky top-4">
              <h3 className="font-serif text-lg mb-3" style={{ color: '#4a3728' }}>Gallery</h3>
              {generatedImages.length === 0 ? (
                <p className="text-sm text-center py-8 opacity-50">No images yet</p>
              ) : (
                <div className="space-y-3">
                  {generatedImages.map((img, idx) => (
                    <div key={idx} className="relative group">
                      <img src={img.url} alt="Generated" className="w-full rounded-lg" />
                      <a
                        href={img.url}
                        download
                        className="absolute top-2 right-2 p-2 bg-white rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity"
                      >
                        <Download size={14} style={{ color: '#4a3728' }} />
                      </a>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
